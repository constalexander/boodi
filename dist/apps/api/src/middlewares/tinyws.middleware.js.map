{
  "version": 3,
  "sources": ["../../../../../apps/api/src/middlewares/tinyws.middleware.ts"],
  "sourcesContent": ["import ws, { WebSocketServer as Server } from 'ws'\nimport http from 'http'\n\n/**\n * Copied from:\n * https://github.com/tinyhttp/tinyws/blob/master/src/index.ts\n */\n\n\ndeclare global {\n    // eslint-disable-next-line @typescript-eslint/no-namespace\n    namespace Express {\n      export interface Request {\n        ws: () => Promise<ws>;\n      }\n    }\n  }\n\nexport interface TinyWSRequest extends http.IncomingMessage {\n  ws: () => Promise<ws>\n}\n\n/**\n * tinyws - adds `req.ws` method that resolves when websocket request appears\n * @param wsOptions\n */\nexport const tinyws =\n  (wsOptions?: ws.ServerOptions, wss: Server = new Server({ ...wsOptions, noServer: true })) =>\n  async (req: TinyWSRequest, _: unknown, next: () => void | Promise<void>) => {\n    const upgradeHeader = (req.headers.upgrade || '').split(',').map((s) => s.trim())\n\n    // When upgrade header contains \"websocket\" it's index is 0\n    if (upgradeHeader.indexOf('websocket') === 0) {\n      req.ws = () =>\n        new Promise((resolve) => {\n          wss.handleUpgrade(req, req.socket, Buffer.alloc(0), (ws) => {\n            wss.emit('connection', ws, req)\n            resolve(ws)\n          })\n        })\n    }\n\n    await next()\n  }"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAA8C;AA0BvC,MAAM,SACX,CAAC,WAA8B,MAAc,IAAI,UAAAA,gBAAO,EAAE,GAAG,WAAW,UAAU,KAAK,CAAC,MACxF,OAAO,KAAoB,GAAY,SAAqC;AAC1E,QAAM,iBAAiB,IAAI,QAAQ,WAAW,IAAI,MAAM,GAAG,EAAE,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC;AAGhF,MAAI,cAAc,QAAQ,WAAW,MAAM,GAAG;AAC5C,QAAI,KAAK,MACP,IAAI,QAAQ,CAAC,YAAY;AACvB,UAAI,cAAc,KAAK,IAAI,QAAQ,OAAO,MAAM,CAAC,GAAG,CAACC,QAAO;AAC1D,YAAI,KAAK,cAAcA,KAAI,GAAG;AAC9B,gBAAQA,GAAE;AAAA,MACZ,CAAC;AAAA,IACH,CAAC;AAAA,EACL;AAEA,QAAM,KAAK;AACb;",
  "names": ["Server", "ws"]
}
